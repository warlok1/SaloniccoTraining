sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/FilterOperator","sap/ui/model/Filter","sap/m/MessageToast"],function(e,t,i,o,a){"use strict";return e.extend("btp.academy.easyapp.controller.Main",{onInit:function(){this.oDialog=null;this.oGlobalBusyDialog=new sap.m.BusyDialog},apiCreate:function(e,t,i){var o={returnStatus:false,data:[]};var a=this;return new Promise(function(s,n){e.create(t,i,{success:function(e){o.returnStatus=true;if(e.results){o.data=e.results}else{o.data=e}s(o.data)},error:function(e){a.oGlobalBusyDialog.close();o.returnStatus=false;n(e)}})})},onAddSimpleRow:function(){this.oGlobalBusyDialog.open();let e=this.getView().getModel().createEntry("/MovmentsMaster").getPath();this._createSimpleDialog(e)},_createSimpleDialog:function(e){this.getView().getModel().setDefaultBindingMode("TwoWay");let i=this.getOwnerComponent().getMetadata().getRootView().viewName.split("."),o=i[0]+"."+i[1]+"."+i[2],a=this.getView();if(!this.oDialog){this.oDialog=t.load({id:a.getId(),name:o+".view.Simple",controller:this}).then(function(t){a.addDependent(t);this.byId("idSmartForm").bindElement(e);return t}.bind(this))}this.oDialog.then(function(e){e.open()})},onDialogAfterOpen:function(){this.oGlobalBusyDialog.close()},onSimpleSave:async function(){let e=this.byId("idSmartForm").check().length;if(e===0){let e=new Date(this.byId("idFieldAccountingDate").getContent().getDateValue());e.setHours(e.getHours()-e.getTimezoneOffset()/60);let t={Account_IdAccount:this.byId("idFieldPosizione").getValue(),AccountingDate:e.toISOString().split("T")[0],VATRate:this.byId("idFieldVATRate").getValue()?this.ParseNumero(this.byId("idFieldVATRate").getValue()):this.byId("idFieldVATRate").getValue(),ImportoLordo:this.ParseNumero(this.byId("idFieldImportoLordo").getValue())};this.getView().getModel().create("/MovmentsMaster",t,{success:()=>{sap.m.MessageToast.show("Salvato");this.byId("idSmartForm").unbindElement();this.getView().getModel().resetChanges();this.byId("newDialog").close();this.getView().getModel().refresh()},error:()=>{sap.m.MessageBox.show("Errore, riprovare")}})}else{sap.m.MessageToast.show("Compile all mandatory fields")}},onAfterCloseDialog:function(){this.getView().getModel().refresh();this.byId("newDialog").destroy();this.oDialog=null},onSimpleClose:function(){this.byId("idSmartForm").unbindElement();this.getView().getModel().resetChanges();this.byId("newDialog").close()},onAddWizardRow:function(){this.oGlobalBusyDialog.open();let e=this.getView().getModel().createEntry("/MovmentsMaster").getPath();this._createWizardDialog(e)},_createWizardDialog:function(e){this.getView().getModel().setDefaultBindingMode("TwoWay");let i=this.getOwnerComponent().getMetadata().getRootView().viewName.split("."),o=i[0]+"."+i[1]+"."+i[2],a=this.getView();if(!this.oDialog){this.oDialog=t.load({id:a.getId(),name:o+".view.Wizard",controller:this}).then(function(t){a.addDependent(t);this.byId("CreateWizard").bindElement(e);return t}.bind(this))}this.oDialog.then(function(e){e.open()})},disableNavigationBar:function(){this.getView().byId("CreateWizard").mAggregations._progressNavigator.ontap=function(){}},onNextStep:async function(){let e=this.byId("CreateWizard").getProgress();switch(e){case 1:this.disableNavigationBar();let e=this.byId("ObligatoryForm").check().length;if(e===0){this.getView().byId("CreateWizard").nextStep()}else{a.show("Please fill the fields with correct values!")}break;case 2:let t=this.byId("SecondForm").check().length;if(t===0){this.getView().byId("CreateWizard").nextStep()}else{a.show("Please fill the fields with correct values!")}break}},onBack:async function(){this.getView().byId("CreateWizard").previousStep()},onSave:async function(){let e=this;let t=this.byId("LastForm").check().length;let i=this.getView().getModel();let o;let a;if(t===0){let e=new Date(this.byId("idFieldAccountingDate").getContent().getDateValue());e.setHours(e.getHours()-e.getTimezoneOffset()/60);let t={Account_IdAccount:this.byId("idFieldPosizione").getValue(),AccountingDate:e.toISOString().split("T")[0],ImportoLordo:this.ParseNumero(this.byId("idFieldImportoLordo").getValue())};o=await this.apiCreate(i,"/MovmentsMaster",t).catch(e=>o=false);if(o){sap.m.MessageToast.show("Salvato");this.byId("CreateWizard").unbindElement();this.getView().getModel().resetChanges();this.byId("newDialog").close();this.getView().getModel().refresh()}else{sap.m.MessageBox.show("Error during creation of movment, retry")}}},callVATRateService:function(e){return new Promise((t,i)=>{let o=this.getOwnerComponent().getManifestEntry("/sap.app/id"),a=o.replaceAll(".","/"),s=jQuery.sap.getModulePath(a);$.ajax({url:s+"/v4/app-movimentazioni-manuali/VATRate(Posizione='"+e.Posizione+"',TipoDiritto='"+e.TipoDiritto+"')",method:"GET",success:o=>{if(o.value.message.includes("Errore")){i(e)}else{e.VATRate=o.value;e.VATRate.CodiceRitenuta=o.value.CausaleRitenuta.substring(0,3);t(true)}},error:()=>{i(e)}})})},onWizardClose:function(){this.byId("CreateWizard").unbindElement();this.getView().getModel().resetChanges();this.byId("newDialog").close()},ParseNumero:function(e){var t=1.1,i=sap.ui.getCore().getConfiguration().getLanguage();t=t.toLocaleString(i).substring(1,2);var o="(["+t+"])(?=.*\\1)";var a=e.replace(new RegExp(o,"g"),"");a=a.replace(new RegExp("[^0-9"+t+"]","g"),"");return Number(a.replace(t,"."))}})});